name: justin-os-surface
description: Surface Pro 7 variant with KDE and linux-surface kernel
base-image: ghcr.io/ublue-os/silverblue-main
image-version: 43

modules:
  # Add linux-surface repo FIRST
  - type: rpm-ostree
    repos:
      - https://pkg.surfacelinux.com/fedora/linux-surface.repo

  # Copy system files and home directory templates
  - type: files
    files:
      - source: home
        destination: /var/home
      - source: system
        destination: /

  # Install RPM Fusion repositories
  - type: rpm-ostree
    install:
      - https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-%OS_VERSION%.noarch.rpm
      - https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-%OS_VERSION%.noarch.rpm

  # Import shared modules
  - from-file: packages-surface.yml
  - from-file: surface-flatpaks.yml

  # VPN SELinux fix (no dash shell service for Surface)
  - type: rpm-ostree
    install:
      - policycoreutils-python-utils

  - type: files
    files:
      - source: scripts/fix-vpn-selinux.sh
        destination: /usr/bin/fix-vpn-selinux.sh
      - source: systemd/fix-vpn-selinux.service
        destination: /usr/lib/systemd/system/fix-vpn-selinux.service

  # Microsoft fonts dependencies and installer
  - type: rpm-ostree
    install:
      - curl
      - cabextract
      - xorg-x11-font-utils # Required by msttcore-fonts-installer
      - fontconfig

  # Install Microsoft Core Fonts and configure zsh (BEFORE changing /bin/sh)
  - type: script
    scripts:
      - install-ms-fonts-build.sh
      - set-default-shell-zsh.sh

  # Surface-specific packages
  - type: rpm-ostree
    install:
      - kernel-surface
      - kernel-surface-default-watchdog
      - iptsd
      - libwacom-surface
      - libwacom-surface-data
      - surface-secureboot
      - thermald
    remove:
      - kernel
      - kernel-core
      - kernel-modules
      - kernel-modules-core
      - kernel-modules-extra
      - libwacom
      - libwacom-data

  # Enable services
  - type: systemd
    system:
      enabled:
        - thermald.service
        - fix-vpn-selinux.service

  - type: signing
